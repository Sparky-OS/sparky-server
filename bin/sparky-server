#!/bin/bash

#
# sparky-server
#
# This script automates the post-installation setup for Sparky Server editions.
# It checks for root privileges, loads the appropriate localization file, and
# then launches the Sparky Server installer.
#
# Copyright (C) 2019 Pawe≈Ç Pijanowski "pavroo" <pavroo@onet.eu>
# License: GNU GPL3
#
# Last updated: 2019/12/13 by pavroo
#

# --- Localization ---
# Set the directory for localization files.
DEFLOCDIR="/usr/share/sparky/sparky-server"

# Detect the system's default locale and load the corresponding language file.
# Falls back to English if the locale is not supported.
if [ -f /etc/default/locale ]; then
    if grep -q "de" /etc/default/locale; then
        . "$DEFLOCDIR/de"
    elif grep -q "el" /etc/default/locale; then
        . "$DEFLOCDIR/el"
    elif grep -q "fr" /etc/default/locale; then
        . "$DEFLOCDIR/fr"
    elif grep -q "hu" /etc/default/locale; then
        . "$DEFLOCDIR/hu"
    elif grep -q "it" /etc/default/locale; then
        . "$DEFLOCDIR/it"
    elif grep -q "pl" /etc/default/locale; then
        . "$DEFLOCDIR/pl"
    elif grep -q "pt_BR" /etc/default/locale; then
        . "$DEFLOCDIR/pt_BR"
    elif grep -q "ru" /etc/default/locale; then
        . "$DEFLOCDIR/ru"
    else
        . "$DEFLOCDIR/en"
    fi
else
    # Default to English if the locale file is not found.
    . "$DEFLOCDIR/en"
fi

# --- Configuration ---
# Set options for the dialog utility.
DIALOG=$(which dialog)
HEIGHT="17"
WIDTH="75"
TITLE="--title"
YESNO="--yesno"
TITLETEXT="Sparky Server Installer"

# --- Execution ---
# Check if the script is running as root.
if [ "$(whoami)" != "root" ]; then
    echo "$LOCAL1 ... $LOCAL2 ..."
    exit 1
else
    # Launch the Sparky ad-server setup.
    /usr/bin/sparky-ad-server

    # Ask the user if they want to remove the post-install scripts.
    $DIALOG $TITLE "$TITLETEXT" $YESNO "$LOCAL3" $HEIGHT $WIDTH

    # If the user confirms, purge the server scripts.
    if [ "$?" = "0" ]; then
        apt-get purge sparky-server sparky-ad-server -y
        exit 0
    else
        exit 1
    fi
fi

exit 0
